# aiutp_pcb 模块关系图

本文档描述了 `aiutp_pcb`（协议控制块）模块与其他模块之间的调用关系和依赖关系。

## 1. 模块架构总览

```
                              ┌─────────────────────────────────────────────────────────────┐
                              │                    应用层 (Application Layer)                 │
                              │                                                              │
                              │  ┌──────────────┐                                           │
                              │  │    aiutp     │  用户 API 接口                             │
                              │  └──────┬───────┘                                           │
                              └─────────┼───────────────────────────────────────────────────┘
                                        │
                              ┌─────────┼───────────────────────────────────────────────────┐
                              │         │               进程管理层 (Process Layer)            │
                              │         ▼                                                    │
                              │  ┌──────────────┐         ┌────────────────┐                │
                              │  │ aiutp_socket │◄───────►│ aiutp_acceptor │                │
                              │  └──────┬───────┘         └────────────────┘                │
                              │         │                                                    │
                              │         ▼                                                    │
                              │  ┌──────────────┐                                           │
                              │  │aiutp_channel │  连接状态机 (gen_statem)                   │
                              │  └──────┬───────┘                                           │
                              └─────────┼───────────────────────────────────────────────────┘
                                        │
┌───────────────────────────────────────┼───────────────────────────────────────────────────────┐
│                                       │                                                        │
│                          协议核心层 (Protocol Core Layer)                                       │
│                                       │                                                        │
│                                       ▼                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                                          │  │
│  │                              ┌─────────────┐                                            │  │
│  │                              │  aiutp_pcb  │  协议控制块（核心模块）                      │  │
│  │                              └──────┬──────┘                                            │  │
│  │                                     │                                                   │  │
│  │          ┌──────────────────────────┼──────────────────────────┐                       │  │
│  │          │                          │                          │                       │  │
│  │          ▼                          ▼                          ▼                       │  │
│  │  ┌──────────────┐          ┌──────────────┐          ┌──────────────────┐             │  │
│  │  │  aiutp_net   │          │   aiutp_tx   │          │     aiutp_rx     │             │  │
│  │  │ 网络 I/O     │          │  发送处理     │          │     接收处理     │             │  │
│  │  └──────┬───────┘          └──────┬───────┘          └──────────────────┘             │  │
│  │         │                         │                                                    │  │
│  │         │                         │                                                    │  │
│  │         ▼                         ▼                                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                        辅助模块 (Helper Modules)                                  │  │  │
│  │  │                                                                                  │  │  │
│  │  │  ┌────────────────┐  ┌────────────────┐  ┌─────────────┐  ┌───────────────────┐ │  │  │
│  │  │  │ aiutp_pcb_cc   │  │aiutp_pcb_timeout│ │  aiutp_rtt  │  │   aiutp_packet    │ │  │  │
│  │  │  │ 拥塞控制       │  │  超时处理       │  │  RTT 估计   │  │   包编解码        │ │  │  │
│  │  │  └────────────────┘  └────────────────┘  └─────────────┘  └───────────────────┘ │  │  │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                          │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                        数据结构层 (Data Structure Layer)                                  │  │
│  │                                                                                          │  │
│  │   ┌────────────────┐   ┌────────────────┐   ┌────────────────┐   ┌────────────────┐    │  │
│  │   │  aiutp_buffer  │   │  aiutp_queue   │   │  aiutp_delay   │   │   aiutp_util   │    │  │
│  │   │  循环缓冲区     │   │    队列        │   │   延迟历史     │   │   工具函数      │    │  │
│  │   └────────────────┘   └────────────────┘   └────────────────┘   └────────────────┘    │  │
│  │                                                                                          │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                │
└────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## 2. aiutp_pcb 模块详细关系

### 2.1 aiutp_pcb 导出函数

```erlang
%% 生命周期管理
new/3          %% 创建新的 PCB
connect/2      %% 发起出站连接
accept/2       %% 接受入站连接
close/1        %% 关闭连接
closed/1       %% 检查连接是否关闭

%% 数据传输
write/2        %% 写入数据
read/1         %% 读取数据
flush/1        %% 刷新发送队列

%% 包处理
process_incoming/2  %% 处理入站包
check_timeouts/1    %% 检查超时

%% 状态查询
state/1        %% 获取连接状态
```

### 2.2 详细调用关系图

```
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                                aiutp_channel                                          │
│                                                                                       │
│  调用 aiutp_pcb 的函数:                                                               │
│  ├── connect/2      → 发起连接时调用                                                  │
│  ├── accept/2       → 接受连接时调用                                                  │
│  ├── process_incoming/2  → 收到数据包时调用                                           │
│  ├── check_timeouts/1    → 定时器超时时调用                                           │
│  ├── write/2        → 发送数据时调用                                                  │
│  ├── read/1         → 接收数据时调用                                                  │
│  ├── close/1        → 关闭连接时调用                                                  │
│  ├── state/1        → 查询状态时调用                                                  │
│  ├── closed/1       → 检查是否关闭时调用                                              │
│  └── flush/1        → 刷新待发送数据时调用                                            │
│                                                                                       │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│                                  aiutp_pcb                                            │
│                                                                                       │
│                          ┌─────────────────┐                                         │
│                          │   #aiutp_pcb{}  │  协议控制块记录                          │
│                          └────────┬────────┘                                         │
│                                   │                                                   │
│  ┌────────────────────────────────┼────────────────────────────────────────────┐     │
│  │                                │                                             │     │
│  │   内部调用:                     │                                             │     │
│  │                                │                                             │     │
│  │   ┌────────────────────────────▼─────────────────────────────────────────┐  │     │
│  │   │                     process_incoming/2                                │  │     │
│  │   │                                                                       │  │     │
│  │   │  调用链:                                                              │  │     │
│  │   │  dispatch_by_type/3                                                   │  │     │
│  │   │      │                                                                │  │     │
│  │   │      ├──► validate_and_init/2                                         │  │     │
│  │   │      │        │                                                       │  │     │
│  │   │      │        └──► handle_duplicate_acks/2                            │  │     │
│  │   │      │                    │                                           │  │     │
│  │   │      │                    └──► process_ack_and_sack/2                 │  │     │
│  │   │      │                                │                               │  │     │
│  │   │      │                                └──► update_connection_state/2  │  │     │
│  │   │      │                                            │                   │  │     │
│  │   │      │                                            └──► handle_data_and_fin/2  │
│  │   │      │                                                                │  │     │
│  │   │      └──► aiutp_net:send_ack/1  (对于 SYN 包)                         │  │     │
│  │   │                                                                       │  │     │
│  │   └───────────────────────────────────────────────────────────────────────┘  │     │
│  │                                                                             │     │
│  └─────────────────────────────────────────────────────────────────────────────┘     │
│                                                                                       │
└──────────────────────────────────────────────────────────────────────────────────────┘
                    │                    │                    │
                    ▼                    ▼                    ▼
        ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
        │     aiutp_net     │ │     aiutp_tx      │ │     aiutp_rx      │
        │                   │ │                   │ │                   │
        │  被调用函数:       │ │  被调用函数:       │ │  被调用函数:       │
        │  ├─ schedule_ack  │ │  ├─ in/2          │ │  └─ in/2          │
        │  ├─ send_ack      │ │  ├─ extract_acked │ │     (处理入站     │
        │  ├─ send_fin      │ │  ├─ parse_sack_*  │ │      数据包)      │
        │  ├─ send_reset    │ │  └─ update_skip_* │ │                   │
        │  ├─ send_packet   │ │                   │ │                   │
        │  ├─ flush_queue   │ │                   │ │                   │
        │  ├─ flush_packets │ │                   │ │                   │
        │  ├─ is_full       │ │                   │ │                   │
        │  └─ window_size   │ │                   │ │                   │
        │                   │ │                   │ │                   │
        └─────────┬─────────┘ └─────────┬─────────┘ └───────────────────┘
                  │                     │
                  │                     │
                  ▼                     ▼
        ┌───────────────────────────────────────────────────────────────┐
        │                    辅助模块调用关系                             │
        │                                                               │
        │   aiutp_pcb ──► aiutp_pcb_timeout:check_timeouts/1            │
        │   aiutp_pcb ──► aiutp_pcb_cc:caculate_acked_bytes/4           │
        │   aiutp_pcb ──► aiutp_pcb_cc:cc_control/4                     │
        │   aiutp_pcb ──► aiutp_pcb_cc:ack_packet/3                     │
        │   aiutp_pcb ──► aiutp_pcb_cc:selective_ack_packet/3           │
        │   aiutp_pcb ──► aiutp_rtt:caculate_delay/4                    │
        │                                                               │
        │   aiutp_pcb_timeout ──► aiutp_net:flush_packets/1             │
        │   aiutp_pcb_timeout ──► aiutp_net:send_packet/2               │
        │   aiutp_pcb_timeout ──► aiutp_net:send_reset/1                │
        │   aiutp_pcb_timeout ──► aiutp_net:send_keep_alive/1           │
        │   aiutp_pcb_timeout ──► aiutp_net:flush_queue/1               │
        │   aiutp_pcb_timeout ──► aiutp_net:is_full/2                   │
        │   aiutp_pcb_timeout ──► aiutp_pcb_cc:maybe_decay_win/1        │
        │                                                               │
        │   aiutp_pcb_cc ──► aiutp_net:send_n_packets/4                 │
        │   aiutp_pcb_cc ──► aiutp_rtt:caculate_rtt/4                   │
        │                                                               │
        │   aiutp_tx ──► aiutp_net:flush_queue/1                        │
        │   aiutp_tx ──► aiutp_net:is_full/2                            │
        │                                                               │
        │   aiutp_rx ──► aiutp_net:send_ack/1                           │
        │                                                               │
        └───────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
        ┌───────────────────────────────────────────────────────────────┐
        │                    数据结构模块                                │
        │                                                               │
        │   aiutp_buffer  - 循环缓冲区（用于 inbuf/outbuf）              │
        │   aiutp_queue   - 先进先出队列（用于 inque/outque）            │
        │   aiutp_delay   - 延迟历史记录（用于 LEDBAT）                  │
        │   aiutp_util    - 通用工具函数                                 │
        │   aiutp_packet  - 包编解码                                     │
        │                                                               │
        └───────────────────────────────────────────────────────────────┘
```

## 3. 数据流向图

### 3.1 发送数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据发送流程                                    │
│                                                                             │
│   用户数据                                                                   │
│      │                                                                      │
│      ▼                                                                      │
│   aiutp_channel:send/2                                                      │
│      │                                                                      │
│      ▼                                                                      │
│   aiutp_pcb:write/2  ─────────────────────────────────────┐                │
│      │                                                     │                │
│      ▼                                                     │                │
│   aiutp_tx:in/2  ──────► outque (发送队列)                 │                │
│      │                      │                              │                │
│      │                      ▼                              │                │
│      │              aiutp_net:flush_queue/1                │                │
│      │                      │                              │                │
│      │                      ▼                              │ 窗口已满时     │
│      │              outbuf (发送缓冲区)                     │ 状态转换为     │
│      │                      │                              │ CS_CONNECTED_  │
│      │                      ▼                              │ FULL           │
│      │              aiutp_net:send_packet/2                │                │
│      │                      │                              │                │
│      │                      ▼                              │                │
│      │              aiutp_packet:encode/1                  │                │
│      │                      │                              │                │
│      │                      ▼                              │                │
│      │              gen_udp:send/3  ──────► UDP 网络       │                │
│      │                                                     │                │
│      └─────────────────────────────────────────────────────┘                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 接收数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据接收流程                                    │
│                                                                             │
│   UDP 网络 ──────► gen_udp                                                  │
│                      │                                                      │
│                      ▼                                                      │
│               aiutp_socket (UDP 数据包分发)                                  │
│                      │                                                      │
│                      ▼                                                      │
│               aiutp_channel:incoming/2                                      │
│                      │                                                      │
│                      ▼                                                      │
│   ┌──────────────────────────────────────────────────────────────────┐     │
│   │              aiutp_pcb:process_incoming/2                         │     │
│   │                      │                                            │     │
│   │                      ▼                                            │     │
│   │   dispatch_by_type ──► 按包类型分发                               │     │
│   │         │                                                         │     │
│   │         ├── ST_RESET ──► 设置 CS_RESET 状态                       │     │
│   │         ├── ST_SYN   ──► 发送 SYN-ACK，状态转换                   │     │
│   │         └── ST_DATA/ST_STATE/ST_FIN ──►                           │     │
│   │                │                                                  │     │
│   │                ▼                                                  │     │
│   │         validate_and_init                                         │     │
│   │                │                                                  │     │
│   │                ▼                                                  │     │
│   │         handle_duplicate_acks ──► 触发快速重传                    │     │
│   │                │                                                  │     │
│   │                ▼                                                  │     │
│   │         process_ack_and_sack                                      │     │
│   │                │                                                  │     │
│   │                ├── aiutp_tx:extract_acked ──► 从 outbuf 移除      │     │
│   │                ├── aiutp_pcb_cc:cc_control ──► LEDBAT 拥塞控制    │     │
│   │                └── aiutp_rtt:caculate_delay ──► 延迟计算          │     │
│   │                │                                                  │     │
│   │                ▼                                                  │     │
│   │         update_connection_state                                   │     │
│   │                │                                                  │     │
│   │                ▼                                                  │     │
│   │         handle_data_and_fin                                       │     │
│   │                │                                                  │     │
│   │                ▼                                                  │     │
│   │         aiutp_rx:in/2                                             │     │
│   │                │                                                  │     │
│   │                ├── 按序到达 ──► inque (接收队列)                   │     │
│   │                └── 乱序到达 ──► inbuf (重排序缓冲区)              │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                      │                                                      │
│                      ▼                                                      │
│               aiutp_net:schedule_ack ──► 调度 ACK 发送                      │
│                      │                                                      │
│                      ▼                                                      │
│               aiutp_pcb:read/1 ──► 返回数据给用户                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 4. 模块职责总结

| 模块 | 职责 | 与 aiutp_pcb 的关系 |
|------|------|---------------------|
| **aiutp_channel** | 连接状态机（gen_statem） | 调用方：管理 PCB 的生命周期 |
| **aiutp_pcb** | 协议控制块核心 | 中心模块：维护连接状态和处理协议逻辑 |
| **aiutp_net** | 网络 I/O | 被调用：发送/接收数据包，窗口管理 |
| **aiutp_tx** | 发送处理 | 被调用：数据入队，ACK/SACK 处理 |
| **aiutp_rx** | 接收处理 | 被调用：数据包重排序和交付 |
| **aiutp_pcb_cc** | 拥塞控制 | 被调用：LEDBAT 算法，窗口调整 |
| **aiutp_pcb_timeout** | 超时处理 | 被调用：RTO/Keepalive 超时 |
| **aiutp_rtt** | RTT 估计 | 被调用：延迟计算，RTT 平滑 |
| **aiutp_packet** | 包编解码 | 被调用：构造和解析 uTP 包 |
| **aiutp_buffer** | 循环缓冲区 | 数据结构：inbuf/outbuf 的实现 |
| **aiutp_queue** | 队列 | 数据结构：inque/outque 的实现 |
| **aiutp_delay** | 延迟历史 | 数据结构：LEDBAT 延迟样本存储 |

## 5. 状态转换图

```
                                    ┌────────────────┐
                                    │ CS_UNINITIALIZED│
                                    └───────┬────────┘
                                            │ new/3
                                            ▼
                                    ┌────────────────┐
                                    │    CS_IDLE     │
                                    └───────┬────────┘
                        ┌───────────────────┼───────────────────┐
                connect/2                   │               收到 SYN
                        │                   │                   │
                        ▼                   │                   ▼
                ┌────────────────┐          │           ┌────────────────┐
                │  CS_SYN_SENT   │          │           │  CS_SYN_RECV   │
                └───────┬────────┘          │           └───────┬────────┘
                        │                   │                   │
                收到 SYN-ACK                │               收到 DATA
                        │                   │                   │
                        ▼                   │                   ▼
                        └───────────────────┴───────────────────┘
                                            │
                                            ▼
                                    ┌────────────────┐
                    ┌───────────────│  CS_CONNECTED  │───────────────┐
                    │               └───────┬────────┘               │
                    │                       │                        │
                发送窗口满                  │                    close/1
                    │                       │                    或超时
                    ▼                       │                        │
            ┌─────────────────┐             │                        │
            │CS_CONNECTED_FULL│◄────────────┘                        │
            └───────┬─────────┘  窗口恢复                             │
                    │                                                │
                    │ close/1 或超时                                 │
                    │                                                │
                    └────────────────────────┬───────────────────────┘
                                             │
                              ┌──────────────┴──────────────┐
                              │                             │
                         正常关闭                        收到 RESET
                              │                             │
                              ▼                             ▼
                      ┌────────────────┐            ┌────────────────┐
                      │   CS_DESTROY   │            │   CS_RESET     │
                      └────────────────┘            └────────────────┘
```

## 6. 关键数据流

### 6.1 PCB 记录中的关键字段

```erlang
#aiutp_pcb{
    %% 连接标识
    state,              %% 连接状态
    conn_id_recv,       %% 接收连接 ID
    conn_id_send,       %% 发送连接 ID
    socket,             %% UDP socket 引用

    %% 序列号
    seq_nr,             %% 下一个发送序列号
    ack_nr,             %% 下一个期望的序列号 - 1

    %% 缓冲区
    inbuf,              %% 接收重排序缓冲区 (aiutp_buffer)
    outbuf,             %% 发送缓冲区 (aiutp_buffer)
    inque,              %% 接收队列 (aiutp_queue)
    outque,             %% 发送队列 (aiutp_queue)

    %% 窗口控制
    cur_window,         %% 当前发送窗口（字节）
    cur_window_packets, %% 传输中的包数
    max_window,         %% 拥塞窗口
    max_window_user,    %% 对端通告的窗口

    %% RTT/RTO
    rtt,                %% 平滑 RTT
    rtt_var,            %% RTT 变化
    rto,                %% 重传超时

    %% 延迟历史 (LEDBAT)
    our_hist,           %% 我方延迟历史
    their_hist,         %% 对端延迟历史

    %% 拥塞控制
    slow_start,         %% 慢启动标志
    ssthresh,           %% 慢启动阈值

    %% FIN 处理
    fin_sent,           %% 是否已发送 FIN
    fin_sent_acked,     %% FIN 是否已被确认
    got_fin,            %% 是否收到 FIN
    got_fin_reached     %% 是否收到 FIN 前所有数据
}
```

---

*文档生成日期: 2025-12-03*
