# MTU 发现功能需求文档

> 版本: 1.0
> 日期: 2025-12-03
> 状态: 草案

## 1. 概述

### 1.1 背景

当前 aiutp 使用固定的 `PACKET_SIZE = 1296` 字节作为最大包载荷大小。这是一个保守值，在大多数网络环境下都能工作，但无法充分利用网络带宽。

路径 MTU 发现（Path MTU Discovery, PMTUD）允许动态确定网络路径上的最大传输单元，从而：
- 在支持更大 MTU 的网络上提高吞吐量
- 避免在 MTU 较小的网络上发生分片

### 1.2 目标

实现简化版 MTU 发现机制（方案 B），基于探测包超时检测，无需依赖 IP 层 DF 标志或 ICMP 消息。

### 1.3 参考实现

- libutp MTU 发现机制
- RFC 4821: Packetization Layer Path MTU Discovery (PLPMTUD)

## 2. 功能需求

### 2.1 核心功能

| ID | 需求 | 优先级 | 状态 |
|----|------|--------|------|
| MTU-001 | 支持动态 MTU 探测 | 高 | 待实现 |
| MTU-002 | 二分查找确定最优 MTU | 高 | 待实现 |
| MTU-003 | 探测包超时检测 | 高 | 待实现 |
| MTU-004 | 周期性重新探测 | 中 | 待实现 |
| MTU-005 | MTU 探测失败回退 | 高 | 待实现 |
| MTU-006 | 可配置 MTU 范围 | 低 | 待实现 |

### 2.2 功能描述

#### MTU-001: 动态 MTU 探测

**描述**: 在连接建立后，自动启动 MTU 发现过程，逐步探测网络路径支持的最大包大小。

**验收条件**:
- 连接进入 CS_CONNECTED 状态后自动开始探测
- 探测过程不影响正常数据传输
- 探测结果持久化到连接状态

#### MTU-002: 二分查找算法

**描述**: 使用二分查找在 `mtu_floor` 和 `mtu_ceiling` 之间确定最优 MTU。

**验收条件**:
- 初始范围: floor=576, ceiling=1500（可配置）
- 每次探测缩小搜索空间一半
- 当 ceiling - floor <= 16 时停止搜索

#### MTU-003: 超时检测机制

**描述**: 通过探测包的 ACK 超时来判断 MTU 是否过大。

**验收条件**:
- 探测包超时 → 降低 ceiling
- 探测包成功 ACK → 提高 floor
- 重复 ACK（丢包指示）→ 降低 ceiling

#### MTU-004: 周期性重新探测

**描述**: 网络路径可能随时间变化，需要周期性重新探测。

**验收条件**:
- 默认每 30 分钟重新开始 MTU 探测
- 重新探测时保持当前 MTU 直到新值确定
- 可配置重新探测间隔

#### MTU-005: 探测失败回退

**描述**: 当 MTU 探测持续失败时，回退到保守值。

**验收条件**:
- 连续 3 次探测失败后回退到 floor 值
- 回退后延长下次探测间隔
- 记录回退事件用于诊断

#### MTU-006: 可配置参数

**描述**: 允许用户配置 MTU 发现相关参数。

**可配置项**:
- `mtu_discovery_enabled`: 是否启用（默认: true）
- `mtu_floor`: 最小 MTU（默认: 576）
- `mtu_ceiling`: 最大 MTU（默认: 1500）
- `mtu_probe_interval`: 重新探测间隔（默认: 30 分钟）

## 3. 非功能需求

### 3.1 性能

- MTU 探测不应显著增加延迟
- 探测包应尽量与正常数据包合并发送
- 二分查找应在 ~10 次探测内收敛

### 3.2 可靠性

- MTU 发现失败不应影响连接稳定性
- 应优雅处理探测超时和丢包
- 保守回退策略确保连接可用

### 3.3 兼容性

- 与不支持 MTU 发现的对端兼容
- 与现有 aiutp 配置兼容
- 不影响现有 API

## 4. 约束和限制

### 4.1 技术约束

1. **无 DF 标志支持**: Erlang `gen_udp` 不直接支持 `IP_DONTFRAG`
2. **无 ICMP 处理**: 不依赖 ICMP "需要分片" 消息
3. **纯应用层实现**: 完全基于 uTP 协议层检测

### 4.2 设计约束

1. **单探测包**: 同一时间只有一个在途探测包
2. **非阻塞**: 探测过程不阻塞数据传输
3. **向后兼容**: 可通过配置禁用

## 5. 验收标准

### 5.1 功能验收

- [ ] 在标准以太网（MTU=1500）上能发现正确 MTU
- [ ] 在 VPN/隧道环境（MTU<1500）上能降低到正确值
- [ ] MTU 探测失败时能正常回退
- [ ] 禁用 MTU 发现时行为与当前版本一致

### 5.2 性能验收

- [ ] MTU 发现收敛时间 < 30 秒
- [ ] 探测开销 < 正常流量的 1%
- [ ] 无明显延迟增加

## 6. 风险分析

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 误判 MTU 导致丢包 | 中 | 保守回退策略 |
| 探测干扰正常传输 | 低 | 低优先级探测 |
| 网络抖动导致误判 | 中 | 多次确认后调整 |

## 7. 相关文档

- [MTU 发现详细设计](./mtu-discovery-design.md)
- [开发计划](./mtu-discovery-plan.md)
- [libutp MTU 实现分析](../../development/libutp-mtu-analysis.md)
